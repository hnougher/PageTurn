<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>

	<!-- Tell IE to use the most recent mode possible (ie: use IE9 mode when in IE9) -->
	<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
	
	<style type="text/css">
		body {
			background: #ACF;
		}
		.book {
			border: 1px solid #F00;
			height: 600px;
			/*overflow: hidden;*/
			position: absolute;
			width: 800px;
		}
		.book .page {
			background: white;
			border: 1px solid #0F0;
			height: 600px;
			overflow: auto;
			position: absolute;
			width: 400px;
		}
		.book .fakepage {
			border: 1px solid #00F;
			height: 100%;
			left: 0%;
			overflow: hidden;
			position: absolute;
			width: 50%;
			/*visibility: hidden;*/
			
			/*-moz-transform-origin: bottom right;
			-moz-transform: skewy(22deg) scalex(0.75);*/
		}
	</style>

	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.18/jquery-ui.min.js"></script>
	<script type="text/javascript" src="jquery.transform-0.9.3.js"></script>
	<script type="text/javascript" src="run3.js"></script>
	<script type="text/javascript" src="animate-page-complex.js"></script>
	<script type="text/javascript">

var Point = function (X, Y) {
	this._X = X;
	this._Y = Y;
};
Point.prototype = {
	X: function () { return this._X; },
	Y: function () { return this._Y; },
	lineTo: function (P) {
		var vy = this._Y - P.Y();
		var vx = this._X - P.X();
		var m = (vx == 0 ? vy : vy / vx);
		var l = new Line(m, 0);
		return l.parrallelAt(P);
	},
	_toString: function () {
		return "P[" + this._X + "," + this._Y + "]";
	}
};

var Line = function (A, B) {
	this._A = A;
	this._B = B;
};
Line.prototype = {
	A: function () { return this._A; },
	B: function () { return this._B; },
	// X = (Y - B) / A
	X: function (Y) { return (Y - this._B) / this._A; },
	// Y = AX + B
	Y: function (X) { return this._A * X + this._B; },
	
	perpendicularLine: function () {
		return new Line(-1/this._A, 0);
	},
	perpendicularAtX: function (X) {
		return this.perpendicularLine().parrallelAt(new Point(X, this.Y(X)));
	},
	parrallelAt: function (P) {
		// y - y() = a(x - X)
		// Y = AX - AX1 + Y1
		// B = Y1 - AX1
		var newB = P.Y() - this._A * P.X();
		return new Line(this._A, newB);
	},
	_toString: function () {
		return "L[Y=" + this._A + "X+" + this._B + "]";
	}
};


$(function () {
var $debug = $("#debug");
var $d1 = $("#d1");
var $d2 = $("#d2");
var $d3 = $("#d3");
var pullStart = null;

function debug(val) {
	if (typeof val == "object" && typeof val._toString == "function")
		val = val._toString();
	console.log(val);
	//$debug.html(val);
}
function restrictFromTo(from, value, to) {
	return Math.min(Math.max(from,value),to);
}
function TOA(opposite, adjacent) {
	return Math.atan(opposite / adjacent);
}

window.onmousedown = function onMouseDown(e) {
	var layerOffset = $d1.offset();
	//var layerX = Math.max(1, e.clientX - layerOffset.left);
	var layerY = e.clientY - layerOffset.top;
	//pullStart = new Point(-($d1.width() * 0.1), restrictFromTo(0, layerY, $d1.height()));
	pullStart = new Point(0, restrictFromTo(0, layerY, $d1.height()));
	return false;
}
window.onmouseup = function onMouseUp(e) {
	pullStart = null;
	return false;
}

window.onmousemove = function onMouseMove(e) {
	if (pullStart == null)
		return;
	
	var layerOffset = $d1.offset();
	var layerX = Math.max(1, e.clientX - layerOffset.left);
	var layerY = e.clientY - layerOffset.top;
	
	// Starters
	var boxSize = new Point($d1.width(), $d1.height());
	var mouse = new Point(layerX, layerY);
	
	// Line from start to Mouse
	var lineToMouse = pullStart.lineTo(mouse);
	var perpToMouse = lineToMouse.perpendicularAtX(pullStart.X() + layerX / 2);
	
	// Restrict bottom middle corner
	if (perpToMouse.X(boxSize.Y()) > boxSize.X()) {
		perpToMouse = perpToMouse.parrallelAt(boxSize);
	}
	
	// Perpendicular Mid Line
	console.warn("M[" + layerX + "," + layerY + "]", "Y1:" + perpToMouse.Y(0), "X1:" + perpToMouse.X(0));
	
	// Calc d2
	var r2 = TOA(perpToMouse.X(0), perpToMouse.Y(0));
	var ox2 = 0;
	var oy2 = 25;
	var x2 = restrictFromTo(0, perpToMouse.X(0), boxSize.X());
	var y2 = restrictFromTo(0, (r2 > 0 ? 0 : perpToMouse.Y(0)), boxSize.Y());
	
	// Calc d3
/*	var r3 = r2;
	var ox3 = restrictFromTo(0, layerX / boxSize.X(), 100);
	var oy3 = 0;
	var x3 = restrictFromTo(-boxSize.X(), perpToMouse.X(0) - boxSize.X(), 0);
	var y3 = (r2 > 0 ? 0 : -restrictFromTo(0, perpToMouse.Y(0), boxSize.Y()));*/
	var r3 = -r2;
	var ox3 = 0;
	var oy3 = 0;
	var x3 = -x2;
	var y3 = -y2;
	
	$d2.transform({origin:[ox2 + "%", oy2 + "%"], translate:[x2 + "px", y2 + "px"], rotate:r2 + "rad"});
	$d3.transform({rotate:r3 + "rad", origin:[ox3 + "%", oy3 + "%"], translate:[x3 + "px", y3 + "px"]});
}
});

</script>

</head>
<body>

<div id="debug"></div>

<div id="d1" style="overflow:visible;position:absolute;border:1px solid #0F0;left:200px;top:200px;width:400px;height:500px">
	<div id="d2" style="overflow:hidden;position:absolute;border:1px solid #F00;top:-50%;width:200%;height:200%">
		<div id="d3" style="overflow:auto;position:absolute;border:1px solid #00F;top:25%;width:50%;height:50%;background:#444;text-align:justify">
			<h1>This is page 1!<br/>Its super cool because it should really contain a title of some sort! And then we just add some more text to the end to see if all the wrapping is working fine!</h1>
		</div>
	</div>
</div>
<!--div id="d1" style="overflow:visible;position:absolute;border:1px solid #0F0;width:400px;height:500px">
	<div id="d2" style="overflow:hidden;position:absolute;border:1px solid #F00; left:-100%;top:-100%;width:200%;height:200%; -moz-transform-origin:50% 50%; -moz-transform:rotate(-45deg)">
		<div id="d3" style="overflow:auto;position:absolute;border:1px solid #00F; left:50%;top:50%;width:50%;height:50%; -moz-transform-origin:0% 0%; -moz-transform:rotate(45deg);background:#444;text-align:justify">
			<h1>This is page 1!<br/>Its super cool because it should really contain a title of some sort! And then we just add some more text to the end to see if all the wrapping is working fine!</h1>
			<embed src="http://flash-clocks.com/free-flash-clocks-blog-topics/free-flash-clock-188.swf" width="380" height="380" wmode="transparent" type="application/x-shockwave-flash"></embed>
		</div>
	</div>
</div-->
<!--div style="overflow:visible;position:absolute;border:1px solid #0FF;width:400px;height:500px">
	<div style="overflow:visible;position:absolute;border:1px solid #FF0; left:-100%;top:-100%;width:200%;height:200%; -moz-transform-origin:50% 50%; -moz-transform:rotate(10deg)">
		<div style="overflow:auto;position:absolute;border:1px solid #F0F; left:50%;top:50%;width:50%;height:50%;
		-moz-transform-origin:0% 0%; -moz-transform: translate(100%,0%) rotate(10deg);
		background:#444;text-align:justify">
			<h1>This is page 1!<br/>Its super cool because it should really contain a title of some sort! And then we just add some more text to the end to see if all the wrapping is working fine!</h1>
			<embed src="http://flash-clocks.com/free-flash-clocks-blog-topics/free-flash-clock-188.swf" width="380" height="380" wmode="transparent" type="application/x-shockwave-flash"></embed>
		</div>
	</div>
</div-->

</body>
</html>